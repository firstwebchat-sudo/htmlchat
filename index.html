<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Global Chat — Firebase (Embed for Google Sites)</title>
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#60a5fa}
    html,body{height:100%;margin:0;font-family:Inter,ui-sans-serif,system-ui,Segoe UI,Roboto,"Helvetica Neue",Arial}
    body{background:linear-gradient(180deg,#071029 0%, #071b2a 100%);color:#e6eef6;display:flex;align-items:center;justify-content:center;padding:24px}
    .app{width:100%;max-width:980px;background:var(--card);border-radius:12px;box-shadow:0 8px 30px rgba(2,6,23,.6);overflow:hidden;display:grid;grid-template-columns:300px 1fr;min-height:640px}
    .sidebar{padding:16px;border-right:1px solid rgba(255,255,255,.03);display:flex;flex-direction:column;gap:12px}
    h1{font-size:18px;margin:0;color:#dff1ff}
    label{font-size:13px;color:var(--muted)}
    input,button,select,textarea{font:inherit}
    .servers{flex:1;overflow:auto}
    .server{padding:10px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,rgba(255,255,255,.01),transparent);cursor:pointer}
    .server small{display:block;color:var(--muted);font-size:12px}
    .create{padding:10px;background:linear-gradient(180deg,rgba(255,255,255,.02),transparent);border-radius:8px}
    .create input{width:100%;padding:8px;margin-top:6px;border-radius:6px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
    .create button{margin-top:8px;padding:8px 12px;border-radius:6px;border:0;background:var(--accent);color:#021129;cursor:pointer}
    .main{display:flex;flex-direction:column}
    .header{padding:16px;border-bottom:1px solid rgba(255,255,255,.03);display:flex;align-items:center;gap:12px}
    .room-title{font-weight:700}
    .chat{flex:1;display:flex;flex-direction:column;overflow:hidden}
    .messages{flex:1;padding:16px;overflow:auto;display:flex;flex-direction:column;gap:8px}
    .msg{max-width:75%;padding:8px 10px;border-radius:8px;background:linear-gradient(180deg,#0f2133,#0b2a3d);box-shadow:0 2px 6px rgba(2,6,23,.4)}
    .msg.me{margin-left:auto;background:linear-gradient(180deg,#183c2e,#10603f)}
    .meta{font-size:12px;color:var(--muted);margin-bottom:6px}
    .input-area{padding:12px;border-top:1px solid rgba(255,255,255,.03);display:flex;gap:8px;align-items:center}
    .input-area input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,.04);background:transparent;color:inherit}
    .btn{padding:10px 12px;border-radius:8px;border:0;background:var(--accent);color:#021129;cursor:pointer}
    .small{font-size:12px;color:var(--muted)}
    .top-actions{margin-left:auto;display:flex;gap:8px}
    .notice{padding:8px;border-radius:8px;background:linear-gradient(180deg,rgba(255,255,255,.01),transparent);font-size:13px}
    @media(max-width:880px){.app{grid-template-columns:1fr}.sidebar{order:2;border-right:0;border-top:1px solid rgba(255,255,255,.03)}.main{order:1}}
  </style>
</head>
<body>
  <div class="app" role="application">
    <aside class="sidebar">
      <div>
        <h1>Global Chat — Servers</h1>
        <div class="small">Create a password-protected server and share the name with friends.</div>
      </div>

      <div class="servers" id="serverList"></div>

      <div class="create">
        <label>Create new server</label>
        <input id="newServerName" placeholder="Server name (eg. Minecraft Fun)" />
        <input id="newServerPassword" placeholder="Password (required)" type="password" />
        <button id="createServerBtn">Create server</button>
      </div>

      <div class="notice" style="margin-top:8px">Host this page on GitHub Pages / Netlify and embed it into Google Sites via an iframe. See top comments for setup steps.</div>
    </aside>

    <main class="main">
      <div class="header">
        <div>
          <div class="room-title" id="roomTitle">Not connected</div>
          <div class="small" id="roomSubtitle">Join a server to start chatting</div>
        </div>
        <div class="top-actions" id="topActions" style="display:none">
          <button id="leaveBtn" class="btn">Leave</button>
        </div>
      </div>

      <div class="chat">
        <div class="messages" id="messages"></div>

        <div class="input-area">
          <input id="displayName" placeholder="Your name (eg. Alex)" />
          <input id="messageInput" placeholder="Type a message..." />
          <button id="sendBtn" class="btn">Send</button>
        </div>
      </div>
    </main>
  </div>

  <script>
  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
  const firebaseConfig = {
    apiKey: "AIzaSyBsS-GCwInYFOozgsrtbrWGGVpaYt2UXPA",
    authDomain: "global-chat-5965f.firebaseapp.com",
    databaseURL: "https://global-chat-5965f-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "global-chat-5965f",
    storageBucket: "global-chat-5965f.firebasestorage.app",
    messagingSenderId: "53670846439",
    appId: "1:53670846439:web:4793b1fe339d3a09526742",
    measurementId: "G-7E5KCMGWS9"
  };

  (function loadFirebase(){
    const s1 = document.createElement('script');
    s1.src = 'https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js';
    s1.onload = ()=>{ 
      const s2 = document.createElement('script');
      s2.src = 'https://www.gstatic.com/firebasejs/9.22.1/firebase-database-compat.js';
      s2.onload = initApp;
      document.head.appendChild(s2);
    };
    document.head.appendChild(s1);
  })();

  async function sha256Hex(str){
    const enc = new TextEncoder();
    const data = enc.encode(str);
    const hash = await crypto.subtle.digest('SHA-256', data);
    const bytes = new Uint8Array(hash);
    return Array.from(bytes).map(b=>b.toString(16).padStart(2,'0')).join('');
  }

  let app, db;
  let currentServerId = null;
  let currentServerName = null;
  let currentServerHash = null;
  let messagesRef = null;

  const userColors = {};
  function getUserColor(name){
    if(userColors[name]) return userColors[name];
    const palette = ['#ff5555','#55ff55','#5599ff','#ffcc55','#ff55ff','#55ffff','#ff9955','#9955ff','#55ff99','#ffffff'];
    const hash = Array.from(name).reduce((a,c)=>a+c.charCodeAt(0),0);
    const color = palette[hash % palette.length];
    userColors[name] = color;
    return color;
  }

  function initApp(){
    app = firebase.initializeApp(firebaseConfig);
    db = firebase.database();
    attachUIHandlers();
    loadServers();
  }

  const el = id => document.getElementById(id);

  function attachUIHandlers(){
    el('createServerBtn').addEventListener('click', createServer);
    el('leaveBtn').addEventListener('click', leaveServer);
    el('sendBtn').addEventListener('click', sendMessage);
    el('messageInput').addEventListener('keydown', e=>{ if(e.key==='Enter') sendMessage(); });
    el('displayName').value = 'Guest'+Math.floor(Math.random()*9000+1000);
  }

  function loadServers(){
    const ref = db.ref('servers');
    ref.off();
    ref.on('value', snap=>{
      const val = snap.val() || {};
      const list = el('serverList');
      list.innerHTML='';
      const keys = Object.keys(val);
      if(keys.length===0){ list.innerHTML='<div class="small">No servers yet — create one!</div>'; return; }
      keys.forEach(k=>{
        const s = val[k];
        const div = document.createElement('div');
        div.className='server';
        div.innerHTML=`<strong>${s.name}</strong><small>${new Date(s.createdAt).toLocaleString()}</small>`;
        div.addEventListener('click',()=>promptJoinServer(k,s.name));
        list.appendChild(div);
      });
    });
  }

  async function createServer(){
    const name = el('newServerName').value.trim();
    const pass = el('newServerPassword').value;
    if(!name) return alert('Enter a server name');
    if(!pass) return alert('Enter a password');
    const hash = await sha256Hex(pass);
    const ref = db.ref('servers').push();
    await ref.set({name, passwordHash:hash, createdAt:Date.now()});
    joinServer(ref.key,name,hash);
  }

  async function promptJoinServer(id,name){
    const pass = prompt(`Enter password for ${name}`);
    if(pass===null) return;
    const hash = await sha256Hex(pass);
    const snap = await db.ref('servers/'+id+'/passwordHash').get();
    const real = snap.val();
    if(hash!==real){ alert('Incorrect password'); return; }
    joinServer(id,name,real);
  }

  function joinServer(id,name,hash){
    leaveServer();
    currentServerId=id; currentServerName=name; currentServerHash=hash;
    el('roomTitle').textContent=name;
    el('roomSubtitle').textContent='Connected — messages appear in real time';
    el('topActions').style.display='flex';
    messagesRef=db.ref('messages/'+id);
    messagesRef.off();
    messagesRef.on('child_added',snap=>{const msg=snap.val();if(msg) renderMessage(msg);});
  }

  function leaveServer(){
    if(messagesRef) messagesRef.off();
    currentServerId=null; currentServerName=null; currentServerHash=null;
    el('roomTitle').textContent='Not connected';
    el('roomSubtitle').textContent='Join a server to start chatting';
    el('topActions').style.display='none';
    el('messages').innerHTML='';
  }

  async function sendMessage(){
    const text = el('messageInput').value.trim();
    const name = el('displayName').value.trim()||'Guest';
    if(!currentServerId) return alert('Join a server first');
    if(!text) return;
    await db.ref('messages/'+currentServerId).push({user:name,text, time:Date.now()});
    el('messageInput').value='';
  }

  function renderMessage(msg){
    const d=document.createElement('div');
    const me=(el('displayName').value.trim()===msg.user);
    d.className='msg'+(me?' me':'');
    const meta=document.createElement('div');
    meta.className='meta';
    const color=getUserColor(msg.user);
    meta.innerHTML=`<span style='color:${color};font-weight:bold;'>${msg.user}</span> — ${new Date(msg.time).toLocaleTimeString()}`;
    const body=document.createElement('div');
    body.textContent=msg.text;
    d.appendChild(meta);
    d.appendChild(body);
    el('messages').appendChild(d);
    el('messages').scrollTop=el('messages').scrollHeight;
  }
  </script>
</body>
</html>



